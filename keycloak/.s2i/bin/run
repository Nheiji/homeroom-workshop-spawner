#!/bin/bash

set -x

SERVER_URL="https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT"
TOKEN=`cat /var/run/secrets/kubernetes.io/serviceaccount/token`
NAMESPACE=`cat /var/run/secrets/kubernetes.io/serviceaccount/namespace`

NAMESPACE_URL="$SERVER_URL/apis/route.openshift.io/v1/namespaces/$NAMESPACE"
ROUTES_URL="$NAMESPACE_URL/routes/$SPAWNER_APPLICATION"

SPAWNER_HOSTNAME=`curl -s -k -H "Authorization: Bearer $TOKEN" $SERVER_URL | \
    python -c "import json, sys; \
               data = json.loads(sys.stdin.read()); \
               print(data['spec']['host'])"`

KEYCLOAK_ARGS=

if [ -f realm.json ]; then
    cat realm.json | sed \
        -e "s/{{ *SPAWNER_HOSTNAME *}}/$SPAWNER_HOSTNAME/g" \
        -e "s/{{ *OAUTH_CLIENT_SECRET *}}/$OAUTH_CLIENT_SECRET/g" > /tmp/realm.json

    KEYCLOAK_ARGS="$KEYCLOAK_ARGS -Dkeycloak.import=/tmp/realm.json"
    KEYCLOAK_ARGS="$KEYCLOAK_ARGS -Dkeycloak.migration.strategy=IGNORE_EXISTING"
fi

exec start-keycloak.sh -b 0.0.0.0 $KEYCLOAK_ARGS
